---
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import Section from '../components/ui/Section.astro';
import Button from '../components/ui/Button.astro';

// 1. URL base de Strapi (sin /api)
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

let rooms = [];
let error = null;

try {
  // 2. FETCH A STRAPI
  // Usamos populate=* para que traiga la imagen
  const res = await fetch(`${STRAPI_URL}/api/rooms?populate=*`);
  
  if (!res.ok) {
    throw new Error(`API Error: ${res.status}`);
  }

  // Strapi siempre devuelve un objeto { data: [...], meta: {...} }
  const json = await res.json();
  const rawData = json.data; 

  rooms = rawData.map((item: any) => {
    // En Strapi v4, los datos están dentro de .attributes
    const attr = item.attributes; 
    const imgData = attr.imagen?.data?.attributes;

    // 3. IMAGEN (Concatenamos la URL base porque Strapi devuelve rutas relativas tipo /uploads/foto.jpg)
    const image = imgData 
      ? `${STRAPI_URL}${imgData.url}` 
      : "https://images.unsplash.com/photo-defecto...";

    // 4. FEATURES (Lógica de separar por comas si es un string)
    let features = ["Básico"];
    if (attr.caracteristicas) {
       // Si el cliente escribió "Wifi, TV, Baño" en el campo de texto
       features = attr.caracteristicas.split(',').map((f: string) => f.trim());
    }

    // 5. DESCRIPCION (Si usas Rich Text en Strapi, viene en Markdown o bloques, aquí asumimos texto simple)
    const rawContent = attr.description || "";
    const cleanDesc = rawContent.substring(0, 150) + "...";

    return {
      id: item.id,
      title: attr.title,       // Ya no es title.rendered
      description: cleanDesc,
      features: features,
      image: image
    };
  });

} catch (e) {
  console.error("Failed to fetch rooms:", e);
  error = true;
}
---

<MainLayout 
  title="Habitaciones - Confort y Lujo" 
  description="Descubra nuestras 40 habitaciones: dobles, matrimoniales y suites."
>
  <PageHeader 
    title="Nuestras Habitaciones" 
    subtitle="40 espacios únicos diseñados para su descanso absoluto"
    backgroundImage="https://images.unsplash.com/photo-1618773928121-c32242e63f39?q=80&w=2070&auto=format&fit=crop"
  />

  <Section>
    {error ? (
      <div class="text-center py-20">
        <h3 class="text-2xl text-red-500 font-bold">Lo sentimos, no pudimos cargar las habitaciones.</h3>
        <p class="text-white/60">Por favor, intente nuevamente más tarde.</p>
      </div>
    ) : (
      <div class="grid grid-cols-1 gap-16">
        {rooms.map((room, index) => (
          /* 6. Simplified Grid Logic: Removed 'flex-row-reverse' conflict */
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
            
            {/* Image Column */}
            <div class={`relative h-[400px] overflow-hidden rounded-sm group ${index % 2 === 1 ? 'lg:order-2' : 'lg:order-1'}`}>
              <img 
                src={room.image} 
                alt={room.title}
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-dark-900/80 to-transparent lg:hidden"></div>
            </div>
            
            {/* Content Column */}
            <div class={`flex flex-col justify-center ${index % 2 === 1 ? 'lg:order-1' : 'lg:order-2'}`}>
              <span class="text-primary-500 font-bold tracking-widest uppercase text-sm mb-2 block">
                Categoría <span class="text-white/40 ml-2 text-xs">#{room.id}</span>
              </span>
              
              {/* decodeHTML is handled implicitly by JSX, but ensure title is clean */}
              <h2 class="font-heading text-3xl md:text-4xl text-white font-bold mb-6" set:html={room.title} />
              
              <p class="text-white/70 text-lg leading-relaxed mb-8">
                {room.description}
              </p>
              
              <ul class="grid grid-cols-2 gap-4 mb-8">
                {room.features.map((feature: string) => (
                  <li class="flex items-center gap-3 text-white/60 text-sm">
                    <span class="text-primary-500">✓</span> {feature}
                  </li>
                ))}
              </ul>

              <div class="mt-auto">
                <Button href={`/rooms/${room.id}`} size="lg">Reservar Ahora</Button>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </Section>

  {/* Services Section remains unchanged */}
  <Section background="alt" padding="md">
     <div class="text-center max-w-2xl mx-auto">
       <h3 class="font-heading text-3xl text-white font-bold mb-6">Servicios Incluidos</h3>
       {/* ... icons ... */}
     </div>
  </Section>
</MainLayout>