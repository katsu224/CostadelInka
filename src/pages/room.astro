---
import MainLayout from '../layouts/MainLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import Section from '../components/ui/Section.astro';
import Button from '../components/ui/Button.astro';

// 1. Detectamos si la URL del navegador tiene "?preview=true"
const isPreview = Astro.url.searchParams.get('preview') === 'true';

// 2. MAGIA ANTI-CACH√â: Le pasamos un Date.now() a tu API de Next.js
// para obligar a la API a consultar la Base de Datos fresca
const API_URL = `http://localhost:3000/api/v1/delivery/websites/5d86b344-037c-41b2-a616-8e271325b98c/pages/room${isPreview ? `?preview=true&nocache=${Date.now()}` : ''}`;

let rooms = [];
let headerData = {
  title: "Habitaciones",
  subtitle: ""
};

let error = null;

try {
 const res = await fetch(API_URL, {
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
  });
  if (!res.ok) {
    throw new Error(`API Error: ${res.status}`);
  }

  const json = await res.json();
  const blocks = json.data?.blocks || [];

  // üîπ HEADER
  const headerBlock = blocks.find((b: any) => b.type === "header");

  if (headerBlock?.content) {
    headerData = {
      title: headerBlock.content.titulo || "Habitaciones",
      subtitle: headerBlock.content.subtitulo || ""
    };
  }

  // üîπ HABITACIONES
  const habitacionesBlock = blocks.find((b: any) => b.type === "habitaciones");

  if (habitacionesBlock?.content?.habitaciones) {
    const rawData = habitacionesBlock.content.habitaciones;

    rooms = rawData.map((item: any, index: number) => {
      return {
        id: String(index + 1),
        title: item.nombre_del_cuarto || "Habitaci√≥n Est√°ndar",
        image: item.imagen || "https://images.unsplash.com/photo-1618773928121-c32242e63f39?q=80&w=2070&auto=format&fit=crop",
        description: item.descripcion_del_cuarto || "Sin descripci√≥n disponible.",
        features: item.caracteristicas
          ? item.caracteristicas.map((f: any) => f.caracteristica)
          : [],
        price: item.precio ?? null
      };
    });
  }

} catch (e) {
  console.error("Failed to fetch rooms:", e);
  error = true;
}
---

<MainLayout 
  title={`${headerData.title} - Confort y Lujo`}
  description={headerData.subtitle}
>
  {/* Banner decorativo flotante que avisa que est√°s en Modo Borrador */}
  {isPreview && (
    <div class="fixed top-0 left-0 w-full bg-[#9D2B48] text-white text-center py-2 text-sm font-bold z-50 animate-pulse">
      Modo Vista Previa: Est√°s viendo los cambios sin publicar.
    </div>
  )}

  <PageHeader 
    title={headerData.title}
    subtitle={headerData.subtitle}
    backgroundImage="https://images.unsplash.com/photo-1618773928121-c32242e63f39?q=80&w=2070&auto=format&fit=crop"
  />

  <Section>
    {error ? (
      <div class="text-center py-20">
        <h3 class="text-2xl text-red-500 font-bold">
          Lo sentimos, no pudimos cargar las habitaciones.
        </h3>
        <p class="text-white/60">
          Por favor, intente nuevamente m√°s tarde.
        </p>
      </div>
    ) : (
      <div class="grid grid-cols-1 gap-16">
        {rooms.map((room, index) => (
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
            
            {/* Imagen */}
            <div class={`relative h-[400px] overflow-hidden rounded-sm group ${index % 2 === 1 ? 'lg:order-2' : 'lg:order-1'}`}>
              <img 
                src={room.image} 
                alt={room.title}
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-dark-900/80 to-transparent lg:hidden"></div>
            </div>
            
            {/* Contenido */}
            <div class={`flex flex-col justify-center ${index % 2 === 1 ? 'lg:order-1' : 'lg:order-2'}`}>
              
              <span class="text-primary-500 font-bold tracking-widest uppercase text-sm mb-2 block">
                Categor√≠a <span class="text-white/40 ml-2 text-xs">#{room.id}</span>
              </span>
              
              <h2 class="font-heading text-3xl md:text-4xl text-white font-bold mb-6">
                {room.title}
              </h2>
              
              <p class="text-white/70 text-lg leading-relaxed mb-6">
                {room.description}
              </p>

              {room.price !== null && (
                <p class="text-primary-400 text-xl font-semibold mb-6">
                  ${room.price} / noche
                </p>
              )}
              
              {room.features.length > 0 && (
                <ul class="grid grid-cols-2 gap-4 mb-8">
                  {room.features.map((feature: string) => (
                    <li class="flex items-center gap-3 text-white/60 text-sm">
                      <span class="text-primary-500">‚úì</span> {feature}
                    </li>
                  ))}
                </ul>
              )}

              <div class="mt-auto">
                {/* Ojo: A√±ado el par√°metro preview al bot√≥n tambi√©n para que la siguiente p√°gina siga en modo prueba */}
                <Button href={`/rooms/${room.id}${isPreview ? '?preview=true' : ''}`} size="lg">
                  Reservar Ahora
                </Button>
              </div>
            </div>

          </div>
        ))}
      </div>
    )}
  </Section>

  <Section background="alt" padding="md">
    <div class="text-center max-w-2xl mx-auto">
      <h3 class="font-heading text-3xl text-white font-bold mb-6">
        Servicios Incluidos
      </h3>
    </div>
  </Section>

</MainLayout>